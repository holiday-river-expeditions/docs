# 2026-02-28 — Sanity CMS Integration

## What happened

Completed Phase 1 Sanity CMS setup. The website now has full Sanity integration: packages installed, Studio embedded and working, content schemas defined, typed GROQ queries with generated TypeScript types, and a client/query layer in place. Sanity project created, `.env.local` configured, Studio verified at `/studio`. Also resolved all 8 Dependabot security alerts.

## What was built

### Packages installed

- `sanity` v5 — Studio core
- `next-sanity` v12 — Next.js integration (`createClient`, `NextStudio`, `defineQuery`)
- `@sanity/client` v7 — API client (direct dep needed for typegen module augmentation)
- `@sanity/vision` — GROQ playground inside Studio
- `@sanity/image-url` — Image URL builder for responsive images
- `@portabletext/react` — Portable Text renderer for rich text fields

### Configuration files

- `sanity.config.ts` — Studio config (basePath: `/studio`, structureTool, visionTool)
- `sanity.cli.ts` — CLI config for `sanity typegen` (includes typegen output path)
- `src/sanity/env.ts` — Centralized env var access with empty-string fallbacks (safe for CI without secrets)

### Phase 1 schemas (`src/sanity/schemas/`)

| Schema         | Type     | Notes                                          |
| -------------- | -------- | ---------------------------------------------- |
| `river`        | document | Colorado, Green, San Juan, Yampa               |
| `activity`     | document | Rafting, Biking, Multi-Sport                   |
| `tripCategory` | document | Family, Stargazing, Canyon Concerts, etc.      |
| `trip`         | document | Core content + Arctic trip ID link             |
| `faq`          | document | Category + sort order for FAQ page             |
| `siteSettings` | document | Singleton: phone, email, address, social links |
| `page`         | document | Generic page builder                           |
| `heroBlock`    | object   | Hero section block (heading, image, CTA)       |
| `contentBlock` | object   | Rich text + image content block                |

*Deferred to later phases: Blog Post, Author, Story/History, Gallery Item.*

### Sanity client utilities (`src/lib/sanity/`)

- `client.ts` — `createClient` from `next-sanity`
- `image.ts` — `urlFor()` helper
- `queries.ts` — GROQ queries using `defineQuery()` (type-safe with `sanity typegen`)
- `fetch.ts` — Fetch helpers (`getAllTrips`, `getTripBySlug`, `getAllRivers`, `getAllFaqs`, `getSiteSettings`, `getPageBySlug`, etc.)
- `index.ts` — Barrel export

### Studio embedding

- `src/app/studio/[[...tool]]/page.tsx` — `NextStudio` client component
- `src/app/studio/[[...tool]]/layout.tsx` — Minimal layout (fragment wrapper, inherits root layout)
- Studio live at `http://localhost:3000/studio`

### Type generation

- `pnpm typegen` runs `sanity schema extract && sanity typegen generate`
- Outputs `src/sanity/types.ts` (8 query types, 24 schema types) — committed to repo
- `schema.json` (intermediate artifact) is gitignored

### Security fixes

- Overrode `rollup` to `>=4.59.0` via `pnpm.overrides` (path traversal fix)
- Updated `eslint`, `sanity`, and transitive deps to resolve `minimatch` and `ajv` ReDoS alerts
- All 8 Dependabot alerts now resolved

## Decisions made

- **Empty-string fallbacks in `env.ts`** rather than throwing on missing vars. Keeps CI green without requiring Sanity secrets in GitHub Actions. Client fails at runtime if called without valid credentials, which is acceptable.
- **Phase 1 schemas only** — Blog Post, Author, Story/History, Gallery Item deferred to Phase 4 to keep scope focused.
- **Studio layout uses fragment wrapper** (not isolated `<html>`/`<body>`) — Next.js App Router only allows `<html>`/`<body>` in the root layout. `NextStudio` handles its own internal styling.
- **Typegen config in `sanity.cli.ts`** — the separate `sanity-typegen.json` config is deprecated. Config lives in `sanity.cli.ts` under `typegen.generates`.
- **CORS origin** added at sanity.io/manage: `http://localhost:3000` (with credentials).

## Sanity project setup completed

- Sanity project created at sanity.io/manage (project ID: `jau3o5v4`, dataset: `production`)
- `.env.local` configured with project ID, dataset, and API token
- CORS origin added for `http://localhost:3000`
- Still need to add Sanity env vars to Vercel project settings and GitHub Actions secrets

## What's next

### Remaining Phase 1 work

- Tailwind brand tokens (waiting on design sync with Ezra/Riley)
- Core layout: header, footer, navigation
- Component library basics (buttons, cards, section containers)
- Add Sanity env vars to Vercel + GitHub Actions

### Phase 3 (parallel)

- Create `hre-website` API client in Arctic admin (User level access)
- Store credentials in Vercel env vars
- Build typed Arctic API client in `src/lib/arctic/`

## Related

- [[build-phases]] — Phase 1 Sanity items checked off
- [[architecture]] — Content models now implemented
